(()=>{"use strict";var e={574:function(e,t,r){var i=this&&this.__awaiter||function(e,t,r,i){return new(r||(r=Promise))((function(o,s){function n(e){try{a(i.next(e))}catch(e){s(e)}}function l(e){try{a(i.throw(e))}catch(e){s(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(n,l)}a((i=i.apply(e,t||[])).next())}))},o=this&&this.__asyncValues||function(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t,r=e[Symbol.asyncIterator];return r?r.call(e):(e="function"==typeof __values?__values(e):e[Symbol.iterator](),t={},i("next"),i("throw"),i("return"),t[Symbol.asyncIterator]=function(){return this},t);function i(r){t[r]=e[r]&&function(t){return new Promise((function(i,o){!function(e,t,r,i){Promise.resolve(i).then((function(t){e({value:t,done:r})}),t)}(i,o,(t=e[r](t)).done,t.value)}))}}},s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.DtsWriter=t.Dts=void 0;const n=r(7),l=r(828),a=s(r(361)),d=r(470),u=r(584);class c extends a.default{generate({name:e,main:t,inputDir:r,projectPath:o,outputPath:s,files:l=[],references:a=[]}){var c;return i(this,void 0,void 0,(function*(){let i={};const m=(0,u.resolver)(r),p=s?(0,u.resolver)(s).dir():m;if(s=s||m.resolve("index.d.ts"),this.emit("log",`[dts] generate for ${r} > ${s}`),!l.length||o){const e=yield this.getTsConfig(r,o);l=e.fileNames,i=e.compilerOptions}i.declaration=!0,i.target=i.target||n.ScriptTarget.Latest,i.outDir=i.outDir||p.rootPath;const v=m.rootPath||i.rootDir||o;if(!v)throw Error("[dts] input dir path is required");const f=(0,u.resolver)(v),g=p.rootPath||i.outDir,x=l,w=[`baseDir = "${f.rootPath}"`,`target = ${i.target.toString()}`,`outDir = ${g||""}`,`rootDir = ${i.rootDir||""}`,`moduleResolution = ${(null===(c=i.moduleResolution)||void 0===c?void 0:c.toString())||""}`,"files =",...x.map((e=>`  ${e}`))];this.emit("log:verbose","[dts] params:\n"+w.map((e=>`  ${e}`)).join("\n")),yield(0,d.mkdirp)((0,u.getDir)(s));const $=new h({name:e,main:t,references:a});$.on("log",(e=>this.emit("log",e))),$.on("log:verbose",(e=>this.emit("log:verbose",e))),yield $.write(f.rootPath,s,i,x)}))}getTsConfig(e,t){var r,s,n,l;return i(this,void 0,void 0,(function*(){const i=(0,u.resolver)(e),a=[t&&(0,u.resolver)(t).resolve("tsconfig.json"),t,i.resolve("tsconfig.json")].filter(Boolean);try{for(var c,h=!0,m=o(a);c=yield m.next(),!(r=c.done);){l=c.value,h=!1;try{const e=l;if(yield(0,d.pathExists)(e))return this.emit("log",`[dts] tsconfig from ${e}`),yield v(e)}finally{h=!0}}}catch(e){s={error:e}}finally{try{h||r||!(n=m.return)||(yield n.call(m))}finally{if(s)throw s.error}}throw Error(`Can't find tsconfig in ${t||i.rootPath}`)}))}}t.Dts=c;class h extends a.default{constructor(e){super(),this.ident="  ",this.externalModules=[],this.options=Object.assign({main:"index",references:[],excludedPatterns:["**/node_modules/**/*.d.ts","**/.yarn/**/*.d.ts"]},e),this.options.main||(this.options.main="index")}write(e,t,r,o){var s;return i(this,void 0,void 0,(function*(){this.externalModules=[],this.emit("log","[dtsw] start");const i=(0,n.createCompilerHost)(r),a=(0,n.createProgram)(o,r,i),c=a.getSourceFiles(),h=(0,u.resolver)(t).dir(),m=(0,u.resolver)(e),p=`${this.options.name}/${(null===(s=this.options.main)||void 0===s?void 0:s.replace(/^\/+/,""))||"index"}`;let v=[];this.listExternals(c),this.inDir=m,this.outDir=h,this.output=(0,d.createWriteStream)(t,{mode:parseInt("644",8)}),this.emit("log","[dtsw] process files"),this.writeReferences(),c.some((e=>{var t;const i=(0,u.normalize)(e.fileName);if(!m.includes(i))return this.emit("log:verbose",`[dtsw] process: ignored library ${i}`),!1;if(null===(t=this.options.excludedPatterns)||void 0===t?void 0:t.some((e=>(0,l.minimatch)(i,e))))return this.emit("log:verbose",`[dtsw] process: excluded ${i}`),!1;if(".d.ts"===i.slice(-5))return this.emit("log:verbose",`[dtsw] process: d.ts ${i}`),this.writeDeclaration(e),!1;const o=this.resolveModule({currentModule:m.relative(g(e.fileName))});p===o&&(this.emit("log:verbose",`[dtsw] main found ${p}`),v=this.getModuleExports(e));const s=a.emit(e,((e,t)=>{".d.ts"===e.slice(-5)?(this.emit("log:verbose",`[dtsw] process: ts ${e}`),this.writeDeclaration((0,n.createSourceFile)(e,t,r.target,!0))):this.emit("log:verbose",`[dtsw] process: ignored d.ts ${e}`)}));if(s.emitSkipped||s.diagnostics.length>0)throw this.emit("log:verbose",`[dtsw] process: ts ${i} error`),f(s.diagnostics.concat(a.getSemanticDiagnostics(e)).concat(a.getSyntacticDiagnostics(e)).concat(a.getDeclarationDiagnostics(e)));return!1})),this.writeMainDeclaration(r.target,v),this.output.close(),this.emit("log","[dtsw] done")}))}listExternals(e){this.emit("log","[dtsw] list externals"),e.forEach((e=>{p(e,(e=>{if(m.isModuleDeclaration(e)){const t=e.name;m.isStringLiteral(t)&&this.externalModules.push(t.text)}}))})),this.externalModules.length?this.emit("log:verbose",["[dtsw] list externals:",...this.externalModules.map((e=>`  - ${e}`))].join("\n")):this.emit("log:verbose","[dtsw] list externals: no externals found")}writeReferences(){var e;const t=/^\./;null===(e=this.options.references)||void 0===e||e.forEach((e=>{t.test(e)?(this.emit("log",`[dtsw] ref.path ${e}`),this.writeOutput(`/// <reference path="${e}" />`)):(this.emit("log",`[dtsw] ref.types ${e}`),this.writeOutput(`/// <reference types="${e}" />`))}))}writeDeclaration(e){var t,r;const i=(0,u.resolve)(e.fileName),o=g((null===(t=this.inDir)||void 0===t?void 0:t.relative(i))||"");if(!o)throw Error(`[dtsw] unable to resolve current module for ${o}`);e.externalModuleIndicator?this.writeExternalDeclaration(e,o):i!==(null===(r=this.output)||void 0===r?void 0:r.path)?(this.emit("log",`[dtsw] declare ${o} from text`),this.writeOutputModule(o,e.text),this.emit("log:verbose",`[dtsw] declare ${o} done`)):this.emit("log:verbose",`[dtsw] declare ignored ${o}`)}writeMainDeclaration(e,t=[]){if(!t.length)return;const r=`${this.options.name}/${this.options.main}`,i=[];this.emit("log",`[dtsw] declare:main ${r}`),!e||e<n.ScriptTarget.ES2015?(this.emit("log:verbose","[dtsw] declare:main require"),i.push(`import main = require('${r}');`),i.push("export = main;")):(t.includes("default")&&(this.emit("log:verbose","[dtsw] declare:main export default"),i.push(`export { default } from '${r}';`)),t.some((e=>"default"!==e))&&(this.emit("log:verbose","[dtsw] declare:main export *"),i.push(`export * from '${r}';`))),i.length||this.emit("log","[dtsw] declare:main no valid exports"),this.writeOutputModule(this.options.name,i.join("\n"))}getModuleExports(e){const t=[];return(0,n.forEachChild)(e,(e=>{var r;m.isExportAssignment(e)?t.push("default"):m.isExportDeclaration(e)?t.push("*"):m.isNamedExports(e)?e.elements.forEach((e=>{var r;t.push((null===(r=e.propertyName)||void 0===r?void 0:r.getText())||e.name.getText())})):m.isVariableStatement(e)&&(null===(r=e.modifiers)||void 0===r?void 0:r.some((e=>e.kind===n.SyntaxKind.ExportKeyword)))&&e.declarationList.declarations.length&&t.push("*")})),t}writeExternalDeclaration(e,t){const r=this.resolveModule({currentModule:t});this.emit("log",`[dtsw] declare:external ${r} (${e.fileName})`);const i=p(e,(e=>{if(m.isExternalModuleReference(e)){const i=e.expression,o=this.resolveImport({importedModule:i.text,currentModule:t});return this.emit("log:verbose",`[dtsw] declare:external ${r}: require ${o}`),` require('${o}')`}if(m.isDeclareKeyWord(e))return this.emit("log:verbose",`[dtsw] declare:external ${r}: ignored declare keyword`),"";if(m.isStringLiteral(e)&&e.parent&&(m.isExportDeclaration(e.parent)||m.isImportDeclaration(e.parent))){const i=e.text,o=this.resolveImport({importedModule:i,currentModule:t});if(o)return this.emit("log:verbose",`[dtsw] declare:external ${r}: import ${o}`),` '${o}'`}}));this.writeOutputModule(r,i.join("")),this.emit("log:verbose",`[dtsw] declare:external ${r} done`)}writeOutput(e,t=0){if(!this.output)throw Error("[dtsw] output stream not set");this.output.write(e+"\n")}writeOutputModule(e,t){const r=t.split(/[\r\n]+|; |;$/).filter((e=>e&&"export {};"!==e)).map((e=>e.replace(/\t/g,this.ident))).map((e=>`${this.ident}${e}`.replace(/\s{4}/g,this.ident).replace(/ (\w+)\(/,((e,t)=>"import"!==t?` ${t} (`:e)).replace(/^\s+private .+$/,""))).filter(Boolean);r.length&&(this.writeOutput(`declare module '${e}' {`),this.writeOutput(r.join("\n")),this.writeOutput("}"))}resolveModule(e){let t=e.currentModule;return t=this.options.resolvedModule?this.options.resolvedModule(e)||t:t.replace(/^.+\/src/,"src"),t=`${this.options.name}/${t}`,this.emit("log:verbose",`[dtsw] resolve ${t} (${e.currentModule})`),t}resolveImport(e){const t=this.externalModules.includes(e.importedModule)||!/^\./.test(e.importedModule),r=t?e.importedModule:(0,u.merge)((0,u.getDir)(e.currentModule),e.importedModule);let i=r;return i=this.options.resolvedImport?this.options.resolvedImport({currentModule:e.currentModule,importedModule:r,isExternal:t})||i:i.replace(/^.+\/src/,"src"),i=t?i:`${this.options.name}/${i}`,this.emit("log:verbose",`[dtsw] resolve:import ${i}${t?" (external)":""} (${e.currentModule}, ${e.importedModule})`),i}}t.DtsWriter=h;const m={isDeclareKeyWord:e=>e&&e.kind===n.SyntaxKind.DeclareKeyword,isImportDeclaration:e=>e&&e.kind===n.SyntaxKind.ImportDeclaration,isExternalModuleReference:e=>e&&e.kind===n.SyntaxKind.ExternalModuleReference,isStringLiteral:e=>e&&e.kind===n.SyntaxKind.StringLiteral,isExportDeclaration:e=>e&&e.kind===n.SyntaxKind.ExportDeclaration,isExportAssignment:e=>e&&e.kind===n.SyntaxKind.ExportAssignment,isNamedExports:e=>e&&e.kind===n.SyntaxKind.NamedExports,isVariableStatement:e=>e&&e.kind===n.SyntaxKind.VariableStatement,isModuleDeclaration:e=>e&&e.kind===n.SyntaxKind.ModuleDeclaration},p=(e,t)=>{const r=[];let i=0;return function o(s){!function(t){r.push(e.text.slice(i,t.pos)),i=t.pos}(s);const l=t(s);void 0!==l?(r.push(l),function(e){i=e.end}(s)):(0,n.forEachChild)(s,o)}(e),r.push(e.text.slice(i)),r.filter(Boolean)},v=e=>i(void 0,void 0,void 0,(function*(){var t;const r=yield(0,d.readFile)(e,{encoding:"utf8"}),i=(0,n.parseConfigFileTextToJson)(e,r);if(i.error)throw f([i.error]);const o=i.config,s=(0,n.parseJsonConfigFileContent)(o,n.sys,(0,u.getDir)(e));if(null===(t=s.errors)||void 0===t?void 0:t.length)throw f(s.errors);return{fileNames:s.fileNames,compilerOptions:s.options}})),f=e=>{const t=["Declaration generation failed"];e.forEach((e=>{const r="string"==typeof e.messageText?e.messageText:e.messageText.messageText;if(e.file){const i=e.file.getLineAndCharacterOfPosition(e.start||0);t.push(`${e.file.fileName}(${i.line+1},${i.character+1}): error TS${e.code}: ${r}`)}else t.push(`error TS${e.code}: ${r}`)}));const r=new Error(t.join("\n"));return r.name="EmitterError",r},g=e=>e.replace(/(\.d)?\.ts$/,"")},584:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.removeExt=t.merge=t.resolve=t.resolver=t.getName=t.getDir=t.normalize=t.PathResolver=void 0;const i=r(17);class o{constructor(e){this.rootPath=(0,t.normalize)((0,i.resolve)(e))}relative(e){return(0,t.normalize)((0,i.relative)(this.rootPath,(0,t.normalize)(e)))}relativeList(e){return e.map((e=>this.relative(e)))}includes(e){return 0===(0,t.normalize)(e).indexOf(this.rootPath)}resolve(...e){return(0,t.normalize)((0,i.resolve)(this.rootPath,...e.filter(Boolean).map((e=>e.replace(/^\/+/,"")))))}resolveList(e){return e.map((e=>this.resolve(e)))}dir(){return(0,t.resolver)((0,t.getDir)(this.rootPath))}res(...e){return(0,t.resolver)(this.resolve(...e))}}t.PathResolver=o,t.normalize=e=>(null==e?void 0:e.replace(/\\/g,"/"))||"",t.getDir=e=>(0,t.normalize)(e).replace(/\/[^/]+\/?$/,""),t.getName=e=>(0,i.basename)((0,t.normalize)(e)),t.resolver=e=>new o(e),t.resolve=e=>(0,t.normalize)((0,i.resolve)(e)),t.merge=(...e)=>(0,t.normalize)((0,i.join)(...e)),t.removeExt=e=>null==e?void 0:e.replace(/\.([^/]+)$/,"")},470:e=>{e.exports=require("fs-extra")},828:e=>{e.exports=require("minimatch")},7:e=>{e.exports=require("typescript")},361:e=>{e.exports=require("events")},17:e=>{e.exports=require("path")}},t={},r=function r(i){var o=t[i];if(void 0!==o)return o.exports;var s=t[i]={exports:{}};return e[i].call(s.exports,s,s.exports,r),s.exports}(574);module.exports=r})();